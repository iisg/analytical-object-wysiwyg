var analyticalObjectWysiwyg;analyticalObjectWysiwyg=angular.module("AnalyticalObjectWysiwyg",["AnalyticalObjectWysiwygTemplates"]),analyticalObjectWysiwyg.directive("analyticalObjectWysiwyg",["$timeout","TaggableObjectQuillFormat",function(t,e){return{scope:{toolbar:"@?",readOnly:"@?",ngModel:"="},require:"ngModel",restrict:"AE",templateUrl:"templates/analyticalObjectWysiwygEditor.html",link:function(t,i,n,o){var r,l,a;return e.register(),r={theme:"base",readOnly:t.readOnly||!1},l=new Quill(i[0].querySelector(".editor-container"),r),t.$emit("quill.created",l),t.toolbar&&"true"===t.toolbar&&l.addModule("toolbar",{container:i[0].querySelector(".toolbar-container"),formats:{tooltip:{object:"object"}}}),a=!0,t.$watch("ngModel",function(t){return null!=t&&a?(l.setHTML(t),a=!1):void 0}),l.on("text-change",function(){return t.modelLength=l.getLength(),o.$setViewValue(l.getHTML())}),i.on("destroy",function(){return l.destroy()}),t.$emit("quill.ready",l)}}}]);var TaggableObjectQuillFormat,bind=function(t,e){return function(){return t.apply(e,arguments)}};TaggableObjectQuillFormat=function(){function t(){this.factory=bind(this.factory,this),this.resolveEvents=bind(this.resolveEvents,this),this.registerFormat=bind(this.registerFormat,this),this.$get=["$injector","$rootScope","$q",this.factory]}var e;return e={search:function(){return function(t){return t}},"node.add":function(){return function(t,e){return t.className="object label label-default",t.setAttribute("data-object",e.label),t.setAttribute("data-id",e.id),t}},"node.remove":function(){return function(t){return t.removeAttribute("class"),t.removeAttribute("data-object"),t.removeAttribute("data-id"),t}},"node.value":function(){return function(t){return{id:t.getAttribute("data-id"),label:t.getAttribute("data-object")}}}},t.prototype.on=function(t,i){return e[t]=i},t.prototype.registerFormat=function(t,e){return"object"in e.editor.doc.formats||e.addFormat("object",{tag:"SPAN",add:this.resolved["node.add"],remove:function(t){return function(e){return t.resolved["node.remove"](e.node)}}(this),value:this.resolved["node.value"]}),e.addModule("object-format")},t.prototype.resolveEvents=function(t){var i,n,o;this.resolved={},n=[];for(i in e)o=e[i],n.push(this.resolved[i]=t.invoke(o));return n},t.prototype.factory=function(t,e,i){var n,o,r;return this.resolveEvents(t),r=this.resolved,n=function(){function t(t,e){this.quill=t,this.removeFormatting=bind(this.removeFormatting,this),this.applyFormatting=bind(this.applyFormatting,this),this.bindToolbar=bind(this.bindToolbar,this),this.selectionChange=bind(this.selectionChange,this),this.textChange=bind(this.textChange,this),this.utils=new TaggableObjectQuillFormatUtils(this.quill,e),this.utils.hide(),this.quill.on("text-change",this.textChange),this.quill.on("selection-change",this.selectionChange),this.quill.onModuleLoad("toolbar",this.bindToolbar),jQuery(".remove",this.utils.container).on("click",function(t){return function(e){return e.preventDefault(),t.removeFormatting()}}(this))}return t.prototype.textChange=function(){return this.utils.isHidden()?void 0:this.utils.hide()},t.prototype.selectionChange=function(t){var e;if(null!=t&&t.isCollapsed())return e=this.utils.findObject(t),e?this.utils.show(e,t):this.utils.isHidden()?void 0:this.utils.hide()},t.prototype.bindToolbar=function(t){return this.toolbar=t,this.toolbar.initFormat("object",this.applyFormatting)},t.prototype.applyFormatting=function(t,e){var n;if(t)return e?t.isCollapsed()?void 0:(n=this.quill.getText(t.start,t.end),i.when(r.search(n)).then(function(e){return function(i){return t?(t.end===e.quill.getLength()&&e.quill.insertText(t.end," "),e.quill.formatText(t,"object",i,"user")):void 0}}(this))):this.quill.formatText(t,"object",null,"user")},t.prototype.removeFormatting=function(){var t;return t=this.utils.container.data("range"),null!=t?(t.isCollapsed()&&(t=this.utils.expandRange(t)),this.quill.formatText(t,"object",null,"user"),null!=this.toolbar&&this.toolbar.setActive("object",!1),this.utils.hide()):void 0},t}(),o=!1,{register:function(t){return function(){return o?void 0:(o=!0,Quill.registerModule("object-format",n),e.$on("quill.created",t.registerFormat))}}(this)}},t}(),analyticalObjectWysiwyg.provider("TaggableObjectQuillFormat",TaggableObjectQuillFormat);var TaggableObjectQuillFormatUtils,bind=function(t,e){return function(){return t.apply(e,arguments)}};TaggableObjectQuillFormatUtils=function(){function t(t,i){this.quill=t,this.findText=bind(this.findText,this),this.show=bind(this.show,this),this.options=jQuery.extend(i,e),this.container=jQuery(this.quill.addContainer("ql-tooltip")),this.container.addClass("ql-object-tooltip").html(this.options.template),this.object=jQuery(".object",this.container)}var e,i;return e={offset:3,template:"<span class='object'></span> <a class='remove'>Remove object</a>"},i=-1e4,t.prototype.isHidden=function(){return this.container.offset().left===i},t.prototype.hide=function(){return this.container.offset({left:i}),this.container.data("range",null)},t.prototype.show=function(t,e){var i;return i=this.findText(t),this.container.css({left:i.left,top:i.top}),null==t.startOffset&&this.object.text(jQuery(t).data("object")),this.container.data("range",e),this.container.focus()},t.prototype.expandRange=function(t){var e,i,n;return i=this.quill.editor.doc.findLeafAt(t.start,!0),n=t.start-i[1],e=n+i[0].length,{start:n,end:e}},t.prototype.findObject=function(t){var e,i,n;for(n=this.quill.editor.doc.findLeafAt(t.start,!0),e=n[0],null!=e&&(i=e.node);null!==i&&i!==this.quill.root;){if("SPAN"===i.tagName&&-1!==i.className.split(" ").indexOf("object"))return i;i=i.parentNode}return null},t.prototype.findText=function(t){var e,i,n,o,r,l,a;return e=this.container.get(0),null!=t?(l=t.getBoundingClientRect(),r=this.quill.container.getBoundingClientRect(),n=l.left-r.left,o=l.top-r.top,i=n+l.width/2-e.offsetWidth/2,a=o+l.height+this.options.offset,a+e.offsetHeight>this.quill.container.offsetHeight&&(a=o-e.offsetHeight-this.options.offset),i=Math.min(i,this.quill.container.offsetWidth-e.offsetWidth),a=Math.min(a,this.quill.container.offsetHeight-e.offsetHeight)):(i=this.quill.container.offsetWidth/2-e.offsetWidth/2,a=this.quill.container.offsetHeight/2-e.offsetHeight/2),a+=this.quill.container.scrollTop,{left:i,top:a}},t}();